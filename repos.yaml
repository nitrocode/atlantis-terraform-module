# https://www.runatlantis.io/docs/server-configuration.html#repo-config-json
repos:
  - id: /.*/
    # allow repo level custom workflows
    allow_custom_workflows: true
    # allow repo level configs to override the following
    allowed_overrides:
      - apply_requirements
      - workflow
    apply_requirements:
      - approved
    workflow: terraform

workflows:
  terraform:
    plan:
      steps:
        - env:
            name: TF_VAR_terraform_repository
            command: 'echo "github.com/${HEAD_REPO_OWNER}/${HEAD_REPO_NAME}"'
        - env:
            name: TF_VAR_terraform_repository_dir
            command: 'echo "${REPO_REL_DIR}"'
        - env:
            name: TF_VAR_terraform_version
            command: 'echo "${ATLANTIS_TERRAFORM_VERSION}"'
        # These env vars TF_AWS_DEFAULT_TAGS_ will work for aws provider 5.62.0+
        # https://github.com/hashicorp/terraform-provider-aws/releases/tag/v5.62.0
        - &env_default_tags_repository
          env:
            name: "TF_AWS_DEFAULT_TAGS_org:repository"
            command: 'echo "github.com/${HEAD_REPO_OWNER}/${HEAD_REPO_NAME}"'
        - &env_default_tags_repository_dir
          env:
            name: "TF_AWS_DEFAULT_TAGS_org:repository_dir"
            command: 'echo "${REPO_REL_DIR}"'
        # Add PR information to cloudtrail by appending the user agent
        - &env_append_user_agent
          env:
            name: TF_APPEND_USER_AGENT
            command: 'echo "pull:${PULL_URL//[^a-zA-Z0-9_@\.:\/-]/} author:${PULL_AUTHOR//[^a-zA-Z0-9-]/} actor:${USER_NAME//[^a-zA-Z0-9-]/}"'
        # https://developer.hashicorp.com/terraform/cli/config/environment-variables#tf_plugin_cache_dir
        - env:
            name: TF_PLUGIN_CACHE_MAY_BREAK_DEPENDENCY_LOCK_FILE
            command: 'echo true'
        # - env:
        #     name: TF_PLUGIN_CACHE_DIR
        #     command: 'echo "$HOME/.terraform.d/plugin-cache"'

        # - run: |
        #     mkdir -p $TF_PLUGIN_CACHE_DIR
        # This will clean up the terraform init output
        - run:
            command: terraform$ATLANTIS_TERRAFORM_VERSION init -input=false
            output: hide

        # verify terraform fmt has run without running format
        - run: |
            terraform$ATLANTIS_TERRAFORM_VERSION fmt -check -list=false
            exit_status=$?
            if [ $exit_status -gt 0 ]; then
              echo "Please run 'terraform fmt' in '${REPO_REL_DIR}'"
              exit $exit_status
            fi

        # use workspace if set
        - run: |
            if [[ ! -z "${WORKSPACE}" ]]; then
              terraform$ATLANTIS_TERRAFORM_VERSION workspace select ${WORKSPACE} || terraform$ATLANTIS_TERRAFORM_VERSION workspace new ${WORKSPACE}
            fi
            echo "Using ${WORKSPACE} workspace"

        # run conftest against terraform hcl code before init
        # The below will separate each terraform file with a new line in order to allow hcl2json to read it properly
        # If "hcl2json < *.tf" or "cat *.tf | hcl2json" is used, it will return "Missing newline after block definition"
        - run: |
            # check for terraform files
            if [ "$(ls | grep '\.tf$')" ]; then
                echo 'conftest --version' && conftest --version
                for f in *.tf; do (cat "${f}"; echo); done | hcl2json | conftest test --all-namespaces -p /atlantis/policy/terraform-code -
            fi
        - run: "echo 'terraform$ATLANTIS_TERRAFORM_VERSION --version' && terraform$ATLANTIS_TERRAFORM_VERSION --version"
        - run: "echo 'tfsec --version' && tfsec --version"
        #- run: "tfsec --concise-output --config-file /etc/tfsec_config.yaml -m CRITICAL --no-color ."
        - run: "tfsec --concise-output -m CRITICAL --no-color ."
        - run: echo 'Running tflint...' && tflint
        - run: echo 'Running checkov...' && checkov -d .
        - plan
        - run: |
            # Show file only exists for >= 0.12
            if [[ "$(echo $ATLANTIS_TERRAFORM_VERSION | cut -d'.' -f1,2)" == "0.11" ]]; then
              exit 0
            fi

            if [ ! -d "/tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM" ]; then
              mkdir -p /tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM
            fi

            terraform$ATLANTIS_TERRAFORM_VERSION show -json $PLANFILE > $SHOW_FILE
            echo 'tf-summarize -v' && tf-summarize -v
            cat $SHOW_FILE | tf-summarize || true
        # Integration from https://github.com/infracost/infracost-atlantis/blob/master/examples/combined-infracost-comment/README.md
        # Run Infracost breakdown and save to a tempfile, namespaced by this project, PR, workspace and dir
        - run: |
            # Show file only exists for >= 0.12
            if [[ "$(echo $ATLANTIS_TERRAFORM_VERSION | cut -d'.' -f1,2)" == "0.11" ]]; then
              exit 0
            fi

            infracost breakdown --path=$SHOW_FILE \
                                --format=json \
                                --log-level=info \
                                --out-file=$INFRACOST_OUTPUT \
                                --project-name=$REPO_REL_DIR

  # custom workflow for authentication
  authenticated:
    apply:
      steps:
        - run: if [ `cat /home/atlantis/users | grep -i "^$USERNAME$" | wc -l` != 1 ]; then echo "Not in users file" && exit 1; else echo "Authenticated"; fi
        - apply
    plan:
      steps:
        - init
        - run: echo 'Running tflint...' && tflint
        - run: echo 'Running checkov...' && checkov -d .
        - plan
